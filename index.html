<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>集中力モニタリング＆自己分析AIサポート</title>
    
    <!-- PWA対応 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#bae0ff">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Bootstrap & CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <!-- Preload audio for better performance -->
    <link rel="preload" as="audio" href="https://cdn.pixabay.com/audio/2022/03/10/audio_4dedf3f94c.mp3">
</head>

<body class="bg-blue-soft">
    <!-- メインコンテナ -->
    <div class="container-fluid px-3 py-4">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8 col-xl-6">
                <div class="card shadow rounded-4 p-4 main-card">
                    
                    <!-- ヘッダー -->
                    <div class="text-center mb-4">
                        <h2 class="text-orange fw-bold mb-2">集中力モニタリング & AIサポート</h2>
                        <div class="badge bg-secondary">Ver 2.0 - AI集中度判定対応</div>
                    </div>
                    
                    <!-- 成長表示 -->
                    <div id="growth-area" class="text-center mb-4 p-3 bg-light rounded-3"></div>
                    
                    <!-- BGMアラート表示エリア -->
                    <div id="bgm-alert-area"></div>
                    
                    <!-- メイン画面 -->
                    <div id="main-screen">
                        <!-- カメラセクション -->
                        <div class="mb-4">
                            <div class="position-relative">
                                <video id="camera" autoplay playsinline muted 
                                       class="rounded-3 border border-blue w-100" 
                                       style="max-height: 300px; object-fit: cover;">
                                </video>
                                
                                <!-- カメラオーバーレイ -->
                                <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" 
                                     id="camera-overlay" style="background: rgba(0,0,0,0.7); border-radius: 0.375rem;">
                                    <div class="text-white text-center">
                                        <div class="spinner-border text-light mb-2" role="status"></div>
                                        <div>カメラを準備中...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- カメラコントロール -->
                            <div class="text-center mt-2">
                                <button id="camera-toggle" class="btn btn-danger btn-sm rounded-pill px-4">
                                    <i class="fas fa-camera me-1"></i>カメラON
                                </button>
                                <small class="d-block mt-1 text-muted">※ カメラ使用許可が必要です</small>
                            </div>
                        </div>
                        
                        <!-- 集中状態表示 -->
                        <div id="focus-status" class="alert alert-info text-center mb-3 position-relative">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            集中判定を開始しています...
                        </div>
                        
                        <!-- タイマー表示 -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body p-3 text-center">
                                        <div id="focus-timer" class="h5 mb-0 text-primary">集中: 0s / 非集中: 0s</div>
                                        <small class="text-muted">リアルタイム集中時間</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- セッション記録フォーム -->
                        <div class="card mb-3">
                            <div class="card-header bg-blue text-white">
                                <h6 class="mb-0"><i class="fas fa-edit me-2"></i>セッション記録</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">タグ（複数可、カンマ区切り）</label>
                                    <input id="input-tags" type="text" class="form-control" 
                                           placeholder="例: #勉強, #読書, #作業, #朝活">
                                    <div class="form-text">後で分析に使用されます</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">メモ・振り返り</label>
                                    <textarea id="input-memo" class="form-control" rows="3" 
                                              placeholder="集中できた理由、気づいたこと、次回への改善点など..."></textarea>
                                </div>
                                
                                <button id="save-session" class="btn btn-blue rounded-pill w-100 fw-bold">
                                    <i class="fas fa-save me-2"></i>このセッションを記録
                                </button>
                            </div>
                        </div>
                        
                        <!-- 集中が切れた時の提案 -->
                        <div id="break-or-game" class="card border-warning d-none">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-exclamation-triangle text-warning fs-1"></i>
                                </div>
                                <h6 class="text-warning fw-bold mb-3">集中が切れています</h6>
                                <p class="text-muted mb-3">リフレッシュしませんか？</p>
                                
                                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                    <button id="btn-game" class="btn btn-orange rounded-pill px-4">
                                        <i class="fas fa-gamepad me-2"></i>神経衰弱ゲーム
                                    </button>
                                    <button id="btn-break" class="btn btn-blue rounded-pill px-4">
                                        <i class="fas fa-coffee me-2"></i>休憩タイマー
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 手動テスト用ボタン -->
                        <div class="card bg-light mt-3">
                            <div class="card-body">
                                <h6 class="card-title">機能テスト</h6>
                                <div class="d-grid gap-2 d-md-flex">
                                    <button id="manual-game" class="btn btn-outline-orange rounded-pill flex-fill">
                                        <i class="fas fa-gamepad me-1"></i>神経衰弱
                                    </button>
                                    <button id="manual-break" class="btn btn-outline-blue rounded-pill flex-fill">
                                        <i class="fas fa-clock me-1"></i>休憩タイマー
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ナビゲーションボタン -->
                        <div class="d-flex justify-content-between mt-4">
                            <button id="btn-history" class="btn btn-outline-warning rounded-pill px-4">
                                <i class="fas fa-chart-line me-2"></i>履歴分析
                            </button>
                            <button id="btn-settings" class="btn btn-outline-blue rounded-pill px-4">
                                <i class="fas fa-cog me-2"></i>設定
                            </button>
                        </div>
                    </div>
                    
                    <!-- 神経衰弱ゲーム画面 -->
                    <div id="memory-game-screen" class="d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="text-orange mb-0">
                                <i class="fas fa-gamepad me-2"></i>神経衰弱ゲーム
                            </h4>
                            <button id="back-main-from-game" class="btn btn-outline-secondary btn-sm rounded-pill">
                                <i class="fas fa-arrow-left me-1"></i>戻る
                            </button>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            同じ絵文字のペアを見つけてください。脳のリフレッシュに効果的です！
                        </div>
                        
                        <div id="memory-game" class="mb-4"></div>
                    </div>
                    
                    <!-- 休憩タイマー画面 -->
                    <div id="break-timer-screen" class="d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="text-blue mb-0">
                                <i class="fas fa-coffee me-2"></i>休憩タイマー
                            </h4>
                            <button id="back-main-from-break" class="btn btn-outline-secondary btn-sm rounded-pill">
                                <i class="fas fa-arrow-left me-1"></i>戻る
                            </button>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-body">
                                <h6 class="card-title">休憩時間を設定</h6>
                                <div class="row g-3 mb-3">
                                    <div class="col-4">
                                        <label class="form-label">時</label>
                                        <input type="number" id="break-hour" min="0" max="2" value="0" class="form-control text-center">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">分</label>
                                        <input type="number" id="break-min" min="0" max="59" value="5" class="form-control text-center">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">秒</label>
                                        <input type="number" id="break-sec" min="0" max="59" value="0" class="form-control text-center">
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button id="start-break-timer" class="btn btn-blue rounded-pill fw-bold">
                                        <i class="fas fa-play me-2"></i>休憩スタート
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="break-timer" class="text-center"></div>
                    </div>
                    
                    <!-- 集中履歴画面 -->
                    <div id="history-screen" class="d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="text-yellow mb-0">
                                <i class="fas fa-chart-line me-2"></i>集中履歴
                            </h4>
                            <button id="back-main-from-history" class="btn btn-outline-secondary btn-sm rounded-pill">
                                <i class="fas fa-arrow-left me-1"></i>戻る
                            </button>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-robot me-2"></i>AI分析結果</h6>
                            </div>
                            <div class="card-body">
                                <div id="ai-feedback" class="mb-0">分析中...</div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header bg-yellow text-dark">
                                <h6 class="mb-0"><i class="fas fa-history me-2"></i>セッション履歴</h6>
                            </div>
                            <div class="card-body p-0">
                                <div id="history-list" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 通知/BGM設定画面 -->
                    <div id="settings-screen" class="d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="text-orange mb-0">
                                <i class="fas fa-cog me-2"></i>設定
                            </h4>
                            <button id="back-main-from-settings" class="btn btn-outline-secondary btn-sm rounded-pill">
                                <i class="fas fa-arrow-left me-1"></i>戻る
                            </button>
                        </div>
                        
                        <!-- 重要なお知らせ -->
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>BGMについて:</strong> ブラウザのセキュリティ設定により、BGMを再生するには最初にボタンをクリックする必要があります。
                        </div>
                        
                        <!-- 通知設定 -->
                        <div class="card mb-4">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-bell me-2"></i>通知設定</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable-notify" checked>
                                    <label class="form-check-label fw-bold" for="enable-notify">
                                        デスクトップ通知を有効にする
                                    </label>
                                    <div class="form-text">他のサイトを見ていても通知が届きます</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">通知メッセージ</label>
                                    <input id="notify-msg" type="text" class="form-control" 
                                           value="集中時間をチェックしませんか？" maxlength="50">
                                    <div class="form-text">通知に表示されるメッセージです</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- BGM設定 -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-music me-2"></i>BGM設定</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable-bgm">
                                    <label class="form-check-label fw-bold" for="enable-bgm">
                                        BGMを有効にする
                                    </label>
                                    <div class="form-text">集中時に自動でBGMが流れます</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">BGM選択</label>
                                    <select id="bgm-select" class="form-select">
                                        <option value="none">なし</option>
                                        <option value="relax" selected>リラックス音楽（オンライン）</option>
                                        <option value="cafe">カフェの音（ローカルファイル）</option>
                                        <option value="rain">雨音（ローカルファイル）</option>
                                    </select>
                                    <div class="form-text">
                                        <small>
                                            <i class="fas fa-info-circle me-1"></i>
                                            ローカルファイルは同じフォルダに「cafe_sound.mp3」「rain.mp3」を配置してください
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button id="test-bgm" class="btn btn-success rounded-pill">
                                        <i class="fas fa-play me-2"></i>BGMをテスト再生
                                    </button>
                                </div>
                                
                                <!-- BGMステータス表示 -->
                                <div id="bgm-status" class="alert alert-light mt-3 d-none">
                                    <small>
                                        <i class="fas fa-music me-1"></i>
                                        BGMステータス: <span id="bgm-status-text">停止中</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- アプリ情報
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0"><i class="fas fa-info me-2"></i>アプリ情報</h6>
                            </div>
                            <div class="card-body">
                                <dl class="row mb-0">
                                    <dt class="col-sm-4">バージョン:</dt>
                                    <dd class="col-sm-8">2.0.0</dd>
                                    <dt class="col-sm-4">対応機能:</dt>
                                    <dd class="col-sm-8">AI集中度判定、PWA通知</dd>
                                    <dt class="col-sm-4">開発:</dt>
                                    <dd class="col-sm-8">松浦さん、影澤さん</dd>
                                </dl>
                            </div> -->

                            <!-- 通知テストセクション（BGM設定の後に追加） -->
                            <div class="card mb-4">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-bell-slash me-2"></i>通知機能テスト</h6>
                                </div>
                                <div class="card-body">
                                    <div id="notification-status" class="mb-3">
                                        <small class="text-muted">通知状態を確認中...</small>
                                    </div>
                                    
                                    <div class="alert alert-warning mb-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>テスト手順:</strong><br>
                                        1. 通知許可を要求<br>
                                        2. 基本通知をテスト<br>
                                        3. バックグラウンド通知をテスト<br>
                                        4. 他のタブを開いて通知確認
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button id="request-notification-permission" class="btn btn-primary">
                                            <i class="fas fa-bell me-2"></i>通知許可を要求
                                        </button>
                                        
                                        <button id="test-basic-notification" class="btn btn-success">
                                            <i class="fas fa-comment-dots me-2"></i>基本通知テスト
                                        </button>
                                        
                                        <button id="test-sw-notification" class="btn btn-info">
                                            <i class="fas fa-satellite-dish me-2"></i>バックグラウンド通知テスト
                                        </button>
                                        
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <button id="start-periodic-notifications" class="btn btn-warning btn-sm w-100">
                                                    <i class="fas fa-play me-1"></i>定期通知開始
                                                </button>
                                            </div>
                                            <div class="col-6">
                                                <button id="stop-periodic-notifications" class="btn btn-secondary btn-sm w-100">
                                                    <i class="fas fa-stop me-1"></i>定期通知停止
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            定期通知は他のタブを開いている時のみ動作します
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
    
     <!-- オーディオ要素（BGM用） -->
    <audio id="bgm-audio" loop preload="none">
        <!-- JavaScriptから動的に設定するため、srcは空のままにする -->
    </audio>

    
    <!-- Font Awesome（アイコン用） -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> -->

    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- メインスクリプト -->
    <script src="main.js"></script>
    
    <!-- Service Worker登録 -->
    <script>
        // Service Worker & PWA対応
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('✅ Service Worker registered successfully');
                    
                    // 通知許可を求める
                    if ('Notification' in window && Notification.permission === 'default') {
                        const permission = await Notification.requestPermission();
                        console.log('Notification permission:', permission);
                    }
                } catch (error) {
                    console.error('❌ Service Worker registration failed:', error);
                }
            });
        }
        
        // PWAインストールプロンプト
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // インストールボタンを表示（必要に応じて）
            console.log('💻 PWA install prompt ready');
        });
    </script>
    
    <!-- エラーハンドリング -->
    <script>
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            
            // ユーザーフレンドリーなエラー表示
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            errorDiv.style.zIndex = '9999';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>エラーが発生しました</strong><br>
                ページを再読み込みしてください。
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(errorDiv);
            
            // 5秒後に自動削除
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        });
        
        // オンライン/オフライン状態の監視
        window.addEventListener('online', () => {
            console.log('✅ インターネット接続が復旧しました');
        });
        
        window.addEventListener('offline', () => {
            console.log('❌ インターネット接続が切断されました');
        });
    </script>
</body>
</html>
